<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Dashboard | Interview Cracker AI</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

<style>
*{box-sizing:border-box}
body{margin:0;font-family:Inter,sans-serif;background:#f3f6fb;color:#1e293b}
header{height:60px;background:#fff;border-bottom:1px solid #e5e7eb;display:flex;align-items:center;justify-content:space-between;padding:0 20px}
.status{padding:6px 12px;border-radius:20px;font-size:13px;font-weight:500}
.connected{background:#dcfce7;color:#166534}
.disconnected{background:#fee2e2;color:#991b1b}
.layout{display:grid;grid-template-columns:300px 1fr 360px;gap:16px;padding:16px;height:calc(100vh - 60px)}
.panel{background:#fff;border-radius:10px;box-shadow:0 8px 20px rgba(0,0,0,.05);display:flex;flex-direction:column}
.panel-header{padding:10px 14px;font-weight:600;color:#fff}
.green{background:#10b981}
.blue{background:#0ea5e9}
.purple{background:#8b5cf6}
.orange{background:#f97316}
.panel-body{padding:14px;flex:1;overflow:auto;font-size:14px}
button{width:100%;padding:10px;margin-top:8px;border:none;border-radius:6px;color:#fff;cursor:pointer}
.btn-green{background:#22c55e}
.btn-red{background:#ef4444}
.btn-blue{background:#3b82f6}
.btn-gray{background:#64748b}
textarea,input{width:100%;padding:10px;border-radius:6px;border:1px solid #cbd5f5}
video{width:100%;border-radius:8px;border:1px solid #cbd5f5}
.msg{background:#eef2ff;padding:14px;border-radius:10px;margin-bottom:12px;font-size:15px;line-height:1.6}
.msg b{display:block;margin-bottom:6px;color:#1e3a8a}
small{color:#64748b}
</style>
</head>

<body>

<header>
  <h2>Meeting Assistant</h2>
  <div style="display:flex;gap:10px;align-items:center">
    <div id="apiStatus" class="status disconnected">‚óè Groq Not Connected</div>
    <button class="btn-red" onclick="logout()">Logout</button>
  </div>
</header>

<div class="layout">

<div class="panel">
  <div class="panel-header orange">üë§ Candidate Profile</div>
  <div class="panel-body">

    <label>Groq API Key</label>
    <input type="password" id="apiKeyInput" value="{{ groq_key or '' }}">
    <button class="btn-blue" onclick="saveApiKey()">Save API Key</button>
    <button class="btn-red" onclick="deleteApiKey()">Delete API Key</button>
    <small id="keyInfo">No API key saved</small>

    <hr>

    <div class="panel-header green">üìÑ Resume Scan</div>
    <textarea id="resumeText" style="height:160px">{{ resume_text or '' }}</textarea>
    <button class="btn-green" onclick="saveResume()">Analyze Resume</button>
    <small id="resumeStatus">No resume loaded</small>

    <hr>

    <div class="panel-header blue">üé§ Audio Control</div>
    <button class="btn-green" onclick="startListening()" id="listenBtn" disabled>Start Listening</button>
    <button class="btn-red" onclick="stopListening()">Stop Listening</button>
    <p id="voiceStatus">Idle</p>

    <hr>

    <div class="panel-header purple">üñ• Meeting Capture</div>
    <button class="btn-blue" onclick="startScreen()">Share Screen</button>
    <button class="btn-red" onclick="stopScreen()">Stop Screen</button>

  </div>
</div>

<div class="panel">
  <div class="panel-header blue">üñ• Meeting Screen</div>
  <div class="panel-body">
    <video id="screenVideo" autoplay muted></video>
  </div>
</div>

<div class="panel">
  <div class="panel-header purple">üí¨ AI Answers</div>
  <div class="panel-body" id="conversation">
    <div class="msg"><b>System</b>Configure Groq API to start</div>
  </div>
  <textarea id="manualQuestion" style="margin-top:10px"></textarea>
  <button class="btn-blue" onclick="askDirect()">Ask Groq</button>
  <button class="btn-gray" onclick="clearConversation()">Clear Answers</button>
</div>

</div>

<script>
function logout(){ window.location.href="/"; }

let recognition=null;
let screenStream=null;
let GROQ_API_KEY="";
let resumeContext="";
let aiBusy=false;
let isListening=false;
let listenTimer=null;

const apiStatus=document.getElementById("apiStatus");
const listenBtn=document.getElementById("listenBtn");
const convo=document.getElementById("conversation");
const voiceStatus=document.getElementById("voiceStatus");
const keyInfo=document.getElementById("keyInfo");

function setConnected(){
  apiStatus.innerText="‚óè Groq Connected";
  apiStatus.className="status connected";
  listenBtn.disabled=false;
  keyInfo.innerText="Saved key: "+GROQ_API_KEY.slice(0,6)+"‚Ä¢‚Ä¢‚Ä¢‚Ä¢";
}

/* INIT FROM SERVER */
const backendKey=document.getElementById("apiKeyInput").value.trim();
if(backendKey){
  GROQ_API_KEY=backendKey;
  setConnected();
}

const resumeFromServer=document.getElementById("resumeText").value.trim();
if(resumeFromServer){
  resumeContext=resumeFromServer;
  document.getElementById("resumeStatus").innerText="Resume loaded ‚úî";
}

/* HELPERS */
function addMsg(html){
  const d=document.createElement("div");
  d.className="msg";
  d.innerHTML=html;
  convo.appendChild(d);
  convo.scrollTop=convo.scrollHeight;
}

function clearConversation(){
  convo.innerHTML="<div class='msg'><b>System</b>Conversation cleared</div>";
}

/* API KEY */
async function saveApiKey(){
  const key=document.getElementById("apiKeyInput").value.trim();
  if(!key) return alert("Enter API key");
  GROQ_API_KEY=key;
  setConnected();
}

async function deleteApiKey(){
  GROQ_API_KEY="";
  apiStatus.innerText="‚óè Groq Not Connected";
  apiStatus.className="status disconnected";
  listenBtn.disabled=true;
  keyInfo.innerText="No API key saved";
}

/* RESUME */
async function saveResume(){
  const resume=document.getElementById("resumeText").value.trim();
  if(!resume) return alert("Paste resume text");
  resumeContext=resume;
  document.getElementById("resumeStatus").innerText="Resume analyzed ‚úî";
  addMsg("<b>System</b>Resume saved");
}

/* GROQ (RESUME LOGIC PRESERVED) */
async function askGroq(q){
  if(aiBusy) return;
  aiBusy=true;

  addMsg("<b>Question</b> "+q);

  const thinking=document.createElement("div");
  thinking.className="msg";
  thinking.innerHTML="<b>AI</b> Thinking...";
  convo.appendChild(thinking);

  try{
    const res=await fetch("https://api.groq.com/openai/v1/chat/completions",{
      method:"POST",
      headers:{
        "Authorization":"Bearer "+GROQ_API_KEY,
        "Content-Type":"application/json"
      },
      body:JSON.stringify({
        model:"llama-3.1-8b-instant",
        messages:[
          {
            role:"system",
            content:
              "You are a candidate in a LIVE technical interview.\n\n"+
              "STRICT OUTPUT RULES:\n"+
              "1) Definitions ‚Üí 1‚Äì2 sentences only\n"+
              "2) SQL asked ‚Üí SQL only\n"+
              "3) Code asked ‚Üí Code only\n\n"+
              "Use resume ONLY to align tools.\n\n"+
              "CANDIDATE RESUME:\n"+(resumeContext||"No resume provided.")
          },
          { role:"user", content:q }
        ]
      })
    });

    const data=await res.json();
    thinking.innerHTML="<b>AI Answer</b> "+(data.choices?.[0]?.message?.content||"No response");

  }catch(e){
    thinking.innerHTML="<b>Error</b> Request failed";
  }finally{
    aiBusy=false;
  }
}

/* MIC (AUTO-RESTART FIXED) */
function startListening(){
  if(!GROQ_API_KEY) return alert("Save Groq API key first");
  if(!('webkitSpeechRecognition'in window)) return alert("Use Chrome or Edge");
  if(isListening) return;

  isListening=true;
  voiceStatus.innerText="Listening...";

  recognition=new webkitSpeechRecognition();
  recognition.continuous=true;
  recognition.interimResults=false;
  recognition.lang="en-US";

  recognition.onresult=e=>{
    const text=e.results[e.results.length-1][0].transcript.trim();
    clearTimeout(listenTimer);
    listenTimer=setTimeout(()=>{
      if(text.length>4) askGroq(text);
    },800);
  };

  recognition.onend=()=>{
    if(isListening){
      setTimeout(()=>recognition.start(),500);
    }
  };

  recognition.start();
}

function stopListening(){
  isListening=false;
  if(recognition){
    recognition.onend=null;
    recognition.stop();
    recognition=null;
  }
  voiceStatus.innerText="Stopped";
}

/* SCREEN */
async function startScreen(){
  screenStream = await navigator.mediaDevices.getDisplayMedia({
    video: true,
    audio: {
      echoCancellation: false,
      noiseSuppression: false,
      autoGainControl: false
    }
  });

  document.getElementById("screenVideo").srcObject = screenStream;
}



/* DIRECT */
function askDirect(){
  const q=document.getElementById("manualQuestion").value.trim();
  if(!q) return;
  document.getElementById("manualQuestion").value="";
  askGroq(q);
}
</script>

</body>
</html>
